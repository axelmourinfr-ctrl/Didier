<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Le Monde de Didier</title>
<!-- QRCode (impression QR) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root{--ink:#eaf1ff;--muted:#9fb3c8;--outline:#ffffff22;--glass:#0c173bcc;--accent:#6fffe9;--ok:#5fd38d;--warn:#ffd166;--bad:#ff6b6b}
*{box-sizing:border-box}
html,body{margin:0;color:var(--ink);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#081127,#0a1430 60%,#0b1a3a)}
header{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;padding:12px 14px;background:#071028cc;border-bottom:1px solid #ffffff14;backdrop-filter:blur(8px)}
h1{margin:0;font-size:18px}.sub{font-size:12px;color:var(--muted)} .wrap{max-width:980px;margin:0 auto;padding:14px}
nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
.tab{border:none;border-radius:12px;padding:10px 12px;color:#d6e2ff;font-weight:900;cursor:pointer;background:linear-gradient(180deg,#142352,#0d1a40);border:1px solid var(--outline)}
.tab[aria-selected="true"]{outline:2px solid #6fffe955}
section.view{display:none}.view.active{display:block;animation:fade .25s ease}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1}}

.card{background:var(--glass);border:1px solid var(--outline);border-radius:18px;padding:14px;box-shadow:0 12px 28px #0007,inset 0 1px 0 #ffffff12}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:6px 10px;font-size:12px;background:linear-gradient(180deg,#0e1c43,#0a1635);border:1px solid var(--outline);color:#d7e6ff}
.btn{border:none;border-radius:12px;padding:10px 12px;font-weight:900;color:#fff;background:linear-gradient(180deg,#18305e,#14264b);border:1px solid var(--outline);cursor:pointer}
.btn.green{background:linear-gradient(180deg,#1c6d3b,#175732)} .btn.red{background:linear-gradient(180deg,#7a1e36,#5b1729)} .btn.yellow{background:linear-gradient(180deg,#5a4a1a,#453912)}
.tiny{font-size:12px;color:var(--muted)} .big{font-size:28px;font-weight:900}
input,select{border:1px solid var(--outline);background:#12214a;color:#fff;border-radius:10px;padding:8px 10px}
code{background:#0a1536;padding:2px 6px;border-radius:6px;border:1px solid #ffffff15}

/* Scanner / vid√©o */
#videoEl{width:100%;aspect-ratio:16/9;border-radius:12px;border:1px solid var(--outline);background:#000}
.progress{height:10px;border-radius:999px;background:#09132a;border:1px solid #ffffff14;overflow:hidden}
.progress .bar{height:100%;background:linear-gradient(90deg,#5bc0be,#6fffe9);width:0%}
#fullscreenWrap{position:fixed;inset:0;background:#000d;display:none;align-items:center;justify-content:center;z-index:100}
#fsInner{width:min(900px,96vw);max-height:96vh;background:#0c173b;border:1px solid var(--outline);border-radius:12px;padding:10px}
#fsVideo{width:100%;max-height:70vh;border-radius:12px;border:1px solid var(--outline);background:#000}
#fsControls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
#btnPlayFS{display:none}

/* Shop */
.shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px}
.shop-item{background:linear-gradient(180deg,#0e1d43,#0a1736);border:1px solid var(--outline);border-radius:18px;padding:10px;box-shadow:inset 0 1px 0 #ffffff10,0 10px 24px #0006}
.shop-item img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;border:1px solid #ffffff1e;display:block}
.shop-item .name{font-weight:900;margin-top:6px}
.shop-item .price{color:#ffec99;font-weight:800;margin-top:2px}

/* Dialogs & toasts */
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#081231;border:1px solid var(--outline);border-radius:12px;padding:10px 14px;color:#e8f2ff;box-shadow:0 12px 32px #0008;display:none;z-index:200}
.toast.show{display:block;animation:fade .25s ease}
dialog{border:none;border-radius:16px;background:#0c193a;color:#e8f2ff;border:1px solid var(--outline);max-width:620px;padding:0;box-shadow:0 18px 44px #000b}
dialog::backdrop{background:rgba(0,0,0,.55)}
.modal-head{padding:12px 14px;border-bottom:1px solid #ffffff14;font-weight:900}
.modal-body{padding:12px 14px} .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #ffffff14}
</style>
</head>
<body>
<header>
  <div style="width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#6fffe9,#5bc0be);display:flex;align-items:center;justify-content:center;border:2px solid #ffffff33;box-shadow:0 8px 20px #0006">üéØ</div>
  <div><h1>Le Monde de Didier</h1><div class="sub"><span id="today"></span> ¬∑ M√©dailles : <b id="medals">0</b></div></div>
  <div style="margin-left:auto"><button class="btn" id="btnPrintQR">Imprimer les QR</button></div>
</header>

<div class="wrap">
  <nav class="tabs">
    <button class="tab" data-view="scan" aria-selected="true">üì∑ Scanner</button>
    <button class="tab" data-view="shop">üõçÔ∏è Boutique</button>
    <button class="tab" data-view="history">üìÖ Historique</button>
    <button class="tab" data-view="edu">üë®‚Äçüè´ √âducateur</button>
  </nav>

  <!-- SCAN -->
  <section id="view-scan" class="view active">
    <div class="card">
      <div class="big">Scanner un objectif</div>
      <div class="tiny">Scanne le QR coll√© √† l‚Äôendroit de la t√¢che. La vid√©o se lance en plein √©cran.</div>
      <video id="videoEl" playsinline></video>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnStartCam">D√©marrer la cam√©ra</button>
        <button class="btn" id="btnStopCam">Arr√™ter</button>
        <div class="tiny">Pas de cam√©ra ? <a href="#" id="manualLink">entrer un code</a></div>
      </div>
      <div id="scanResult" class="pill" style="display:none;margin-top:8px"></div>
    </div>
  </section>

  <!-- SHOP -->
  <section id="view-shop" class="view">
    <div class="card">
      <div class="row">
        <div class="big">Boutique (r√©compenses r√©elles)</div>
        <div class="pill">M√©dailles : <b id="medalsShop">0</b></div>
      </div>
      <div id="shopNotice" class="pill" style="margin:8px 0"></div>
      <div class="shop-grid" id="shopGrid"></div>
    </div>
  </section>

  <!-- HISTORIQUE -->
  <section id="view-history" class="view">
    <div class="card">
      <div class="row"><div class="big">Historique (7 jours)</div><div class="pill tiny">Max 2 validations/jour/objectif</div></div>
      <div id="hist" class="grid"></div>
    </div>
  </section>

  <!-- EDU -->
  <section id="view-edu" class="view">
    <div class="card">
      <div class="row"><div class="big">Mode √©ducateur</div><div><input id="pin" type="password" placeholder="PIN 1234" style="width:120px"><button class="btn" id="enterPin">Entrer</button></div></div>
      <div id="eduPanel" style="display:none">
        <div class="grid" style="grid-template-columns:1fr">
          <div class="card">
            <div class="row"><b>Objectifs</b><button class="btn" id="btnAddObj">‚ûï Ajouter</button></div>
            <div id="objList" class="grid" style="grid-template-columns:1fr;gap:8px;margin-top:8px"></div>
          </div>
          <div class="card">
            <div class="row"><b>Articles du shop (r√©els)</b><button class="btn" id="btnAddItem">‚ûï Ajouter</button></div>
            <div id="itemList" class="grid" style="grid-template-columns:1fr;gap:8px;margin-top:8px"></div>
          </div>
          <div class="card">
            <b>Tickets √† valider</b> <span class="tiny">(PIN requis)</span>
            <div id="ticketsList" class="grid" style="grid-template-columns:1fr;gap:8px;margin-top:8px"></div>
          </div>
          <div class="card">
            <b>R√©glages Boutique</b>
            <div class="row"><div>Ouvert de <input id="shopOpen" type="time" value="19:30"> √† <input id="shopClose" type="time" value="21:00"></div>
            <label><input id="lockShop" type="checkbox" checked> Verrouiller hors plage</label>
            <button class="btn" id="btnSaveShop">Enregistrer</button></div>
          </div>
          <div class="card">
            <b>Outils</b>
            <div class="row">
              <button class="btn yellow" id="btnSchema">Donner 1 m√©daille (objectif ‚Äò√âducateur‚Äô)</button>
              <button class="btn red" id="resetDay">R√©initialiser la journ√©e</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- PLEIN √âCRAN VIDEO -->
<div id="fullscreenWrap">
  <div id="fsInner">
    <video id="fsVideo" playsinline controls></video>
    <div class="progress" style="margin-top:8px"><div class="bar" id="timerBar"></div></div>
    <div id="fsControls">
      <div class="tiny">Attends le temps minimum avant de valider.</div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnPlayFS">Lancer la vid√©o ‚ñ∂Ô∏è</button>
        <button class="btn" id="btnCloseFS">Fermer</button>
        <button class="btn green" id="btnValidate" disabled>Valider ‚úÖ</button>
      </div>
    </div>
  </div>
</div>

<!-- DIALOGS -->
<dialog id="dlgManual"><div class="modal-head">Entrer un code d‚Äôobjectif</div><div class="modal-body">
  <input id="manualCode" placeholder="ex: dents" style="width:100%">
</div><div class="modal-actions"><button class="btn" id="mCancel">Annuler</button><button class="btn green" id="mOk">OK</button></div></dialog>

<dialog id="dlgObj"><div class="modal-head" id="objTitle">Nouvel objectif</div><div class="modal-body">
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <label>Nom <input id="objName" /></label>
    <label>Code (QR) <input id="objCode" placeholder="dents"/></label>
    <label>Mode <select id="objMode"><option value="auto">Auto (timer)</option><option value="edu">√âducateur</option></select></label>
    <label>Temps minimum (s) <input id="objMin" type="number" value="40"/></label>
    <label>Vid√©o (chemin) <input id="objVideo" placeholder="videos/dents.mp4"/></label>
  </div>
</div><div class="modal-actions"><button class="btn" id="objCancel">Annuler</button><button class="btn green" id="objSave">Enregistrer</button></div></dialog>

<dialog id="dlgItem"><div class="modal-head" id="itemTitle">Nouvel article</div><div class="modal-body">
  <div class="grid" style="grid-template-columns:1fr 1fr">
    <label>Nom <input id="itemName" placeholder="Chocolat"/></label>
    <label>Prix (m√©dailles) <input id="itemPrice" type="number" value="10"/></label>
    <label>Photo <input id="itemImg" type="file" accept="image/*"/></label>
    <div class="tiny">Astuce : choisis une photo claire et cadr√©e.</div>
  </div>
</div><div class="modal-actions"><button class="btn" id="itemCancel">Annuler</button><button class="btn green" id="itemSave">Enregistrer</button></div></dialog>

<dialog id="dlgTicketUse"><div class="modal-head">Valider le ticket</div><div class="modal-body">
  <div id="ticketSummary"></div>
  <div style="margin-top:8px"><input id="pinUse" type="password" placeholder="PIN 1234"></div>
</div><div class="modal-actions"><button class="btn" id="tCancel">Annuler</button><button class="btn green" id="tValidate">Valider</button></div></dialog>

<div class="toast" id="toast"></div>

<script>
/* ====== Helpers & √âtat ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const STORAGE="didier_simple_v1";
const DEFAULT={
  pin:"1234",
  medals:0,
  shop:{open:"19:30", close:"21:00", locked:true},
  objectives:[
    {id:"dents",   title:"Se brosser les dents", mode:"auto", min:40, video:"videos/dents.mp4"},
    {id:"lavage",  title:"Se laver (douche)",    mode:"auto", min:45, video:"videos/lavage.mp4"},
    {id:"changer", title:"Se changer",           mode:"auto", min:25, video:"videos/changer.mp4"},
    {id:"ranger",  title:"Ranger la chambre",    mode:"auto", min:40, video:"videos/ranger.mp4"},
    {id:"lit",     title:"Faire son lit",        mode:"auto", min:30, video:"videos/lit.mp4"},
    {id:"raser",   title:"Se raser",             mode:"auto", min:40, video:"videos/raser.mp4"},
    {id:"schema",  title:"Sch√©ma corporel",      mode:"edu",  min:0,  video:""}
  ],
  items:[ /* {id,name,price,imgData} */ ],
  tickets:[ /* {id,reward,code,createdAt,used} */ ],
  history:{},   // { 'YYYY-MM-DD': { objId: count(0..2), ... } }
};
let state=load();
function load(){try{return Object.assign({},DEFAULT,JSON.parse(localStorage.getItem(STORAGE)||"{}"));}catch(e){return structuredClone(DEFAULT)}}
function save(){localStorage.setItem(STORAGE,JSON.stringify(state))}
function toast(t){const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1500)}
function todayKey(d=new Date()){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;}
$("#today").textContent=new Date().toLocaleDateString('fr-BE',{weekday:'long',day:'2-digit',month:'long'});

/* ====== Navigation ====== */
$$(".tab").forEach(b=>b.addEventListener("click",()=>{
  $$(".tab").forEach(x=>x.setAttribute("aria-selected","false")); b.setAttribute("aria-selected","true");
  $$(".view").forEach(v=>v.classList.remove("active")); $("#view-"+b.dataset.view).classList.add("active");
  if(b.dataset.view==="shop") renderShop();
  if(b.dataset.view==="history") renderHistory();
}));

/* ====== Scanner QR ====== */
const videoEl=$("#videoEl"); let stream=null, detector=null, scanTimer=null;
async function startCamera(){
  try{
    if(!("BarcodeDetector" in window)) throw "no-detector";
    detector=new BarcodeDetector({formats:["qr_code"]});
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    videoEl.srcObject=stream; await videoEl.play();
    scanTimer=setInterval(scanFrame,350);
    toast("Cam√©ra d√©marr√©e");
  }catch(e){ toast("Scanner non dispo. Utilise le code manuel."); }
}
async function scanFrame(){
  if(!detector||!videoEl) return;
  try{ const bar=await detector.detect(videoEl);
    if(bar.length){ handleCode((bar[0].rawValue||"").trim()); stopCamera(); }
  }catch(e){}
}
function stopCamera(){ clearInterval(scanTimer); scanTimer=null; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
$("#btnStartCam").onclick=startCamera; $("#btnStopCam").onclick=stopCamera;
$("#manualLink").onclick=(e)=>{e.preventDefault(); $("#dlgManual").showModal();};
$("#mCancel").onclick=()=>$("#dlgManual").close();
$("#mOk").onclick=()=>{ const code=$("#manualCode").value.trim(); if(!code) return; $("#dlgManual").close(); handleCode(code); };

function findObjectiveByCode(code){ return state.objectives.find(o=>o.id===code || (o.code && o.code===code)); }

/* ====== Plein √©cran vid√©o + timer ====== */
const fsWrap=$("#fullscreenWrap"), fsVideo=$("#fsVideo"), timerBar=$("#timerBar");
const btnValidate=$("#btnValidate"), btnCloseFS=$("#btnCloseFS"), btnPlayFS=$("#btnPlayFS");
let currentObj=null, timerInt=null, t0=0, minSec=0;
function handleCode(code){
  const obj=findObjectiveByCode(code);
  $("#scanResult").style.display="block";
  if(!obj){ $("#scanResult").textContent="Code inconnu : "+code; return; }
  currentObj=obj; minSec=obj.min||0;
  $("#scanResult").textContent=`‚úÖ ${obj.title}`;
  openFullscreenVideo(obj.video, obj.title);
}
async function openFullscreenVideo(src, title){
  fsVideo.src = src||"";
  btnValidate.disabled=true; timerBar.style.width="0%";
  fsWrap.style.display="flex";
  try{ await fsWrap.requestFullscreen?.(); }catch(e){}
  // tenter autoplay
  let autoWorked=true;
  try{ await fsVideo.play(); }
  catch(e){ autoWorked=false; }
  if(!autoWorked){ btnPlayFS.style.display="inline-block"; }
  else { btnPlayFS.style.display="none"; startTimerWhenPlaying(); }
}
btnPlayFS.onclick=async()=>{ try{ await fsVideo.play(); btnPlayFS.style.display="none"; startTimerWhenPlaying(); }catch(e){} };
btnCloseFS.onclick=()=>closeFS(false);
btnValidate.onclick=()=>{ validateCurrent(); closeFS(true); };

function startTimerWhenPlaying(){
  clearInterval(timerInt);
  t0=0;
  const start = ()=>{ if(t0) return; t0 = Date.now(); timerInt=setInterval(()=>{ const elapsed=(Date.now()-t0)/1000; const pct = minSec? Math.min(100, Math.round(100*elapsed/minSec)) : 100; timerBar.style.width=pct+"%"; if(minSec===0 || elapsed>=minSec){ btnValidate.disabled=false; } },250); };
  const stop = ()=>{ clearInterval(timerInt); timerBar.style.width="0%"; btnValidate.disabled=true; t0=0; };
  fsVideo.addEventListener("playing", start, {once:true});
  fsVideo.addEventListener("pause", ()=>{ /* pas de reset complet, juste pause timer */ }, {once:false});
  // s√©curit√© si d√©j√† playing
  if(!fsVideo.paused) start();
}
function closeFS(fromValidate){
  clearInterval(timerInt); timerBar.style.width="0%"; btnValidate.disabled=true;
  fsVideo.pause(); fsWrap.style.display="none";
  if(document.fullscreenElement){ document.exitFullscreen?.(); }
}
function validateCurrent(){
  if(!currentObj) return;
  const tk=todayKey(); state.history[tk]=state.history[tk]||{};
  const count = state.history[tk][currentObj.id]||0;
  if(count>=2){ toast("Limite quotidienne atteinte pour cet objectif"); return; }
  state.history[tk][currentObj.id] = count+1;
  state.medals += 1;
  save(); refreshCounters();
  toast("Bravo ! +1 m√©daille");
}

/* ====== Shop (r√©el uniquement) ====== */
function speak(text){
  try{ const u=new SpeechSynthesisUtterance(text); u.lang="fr-FR"; u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}
}
function shopOpenNow(){
  if(!state.shop.locked) return true;
  const now=new Date();
  const [h1,m1]=state.shop.open.split(":").map(Number);
  const [h2,m2]=state.shop.close.split(":").map(Number);
  const start=new Date(now); start.setHours(h1,m1,0,0);
  const end=new Date(now); end.setHours(h2,m2,0,0);
  return now>=start && now<=end;
}
function renderShop(){
  $("#medalsShop").textContent=state.medals;
  const notice = shopOpenNow() ? "Boutique ouverte" : `Boutique disponible de ${state.shop.open} √† ${state.shop.close}`;
  $("#shopNotice").textContent=notice;
  const grid=$("#shopGrid"); grid.innerHTML="";
  if(!state.items.length){ grid.innerHTML="<div class='tiny'>Aucun article pour l‚Äôinstant. Ajoutez-en dans l‚Äôonglet √âducateur.</div>"; return; }
  state.items.forEach(it=>{
    const card=document.createElement("div"); card.className="shop-item";
    const im=new Image(); im.src=it.imgData||""; im.alt=it.name; im.loading="lazy";
    im.onclick=()=>speak(`${it.name}. ${it.price} m√©dailles`);
    card.appendChild(im);
    const name=document.createElement("div"); name.className="name"; name.textContent=it.name; name.onclick=()=>speak(it.name); card.appendChild(name);
    const price=document.createElement("div"); price.className="price"; price.textContent=`${it.price} m√©dailles`; card.appendChild(price);
    const buy=document.createElement("button"); buy.className="btn"; buy.textContent="Acheter";
    const disabledByTime = !shopOpenNow() && state.shop.locked;
    buy.disabled = state.medals<it.price || disabledByTime;
    buy.onclick=()=>buyItem(it);
    card.appendChild(buy);
    grid.appendChild(card);
  });
}
function buyItem(it){
  if(state.medals<it.price){ toast("Pas assez de m√©dailles"); return; }
  state.medals -= it.price;
  const code = String(Math.floor(100000 + Math.random()*900000));
  state.tickets.push({id:"t_"+Date.now(), reward:it.name, code, createdAt:new Date().toISOString(), used:false});
  save(); refreshCounters(); renderShop();
  toast(`Ticket cr√©√©: ${it.name}`);
}

/* ====== Historique ====== */
function renderHistory(){
  const box=$("#hist"); box.innerHTML="";
  for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const key=todayKey(d);
    const day = state.history[key]||{};
    const count = Object.values(day).reduce((a,b)=>a+(b||0),0);
    const div=document.createElement("div"); div.className="card";
    let list=""; for(const [k,v] of Object.entries(day)){ const obj=state.objectives.find(o=>o.id===k); list += `<div class="tiny">‚Ä¢ ${(obj?obj.title:k)} √ó ${v}</div>`; }
    div.innerHTML=`<div class="row"><div>${d.toLocaleDateString('fr-BE',{weekday:'short',day:'2-digit'})}</div><div class="pill">${count} validation(s)</div></div>${list||'<div class="tiny" style="opacity:.6">Aucune</div>'}`;
    box.appendChild(div);
  }
}

/* ====== √âducateur ====== */
$("#enterPin").onclick=()=>{ if($("#pin").value===state.pin){ $("#eduPanel").style.display="block"; renderObjList(); renderItemList(); renderTickets(); loadShopSettings(); toast("Mode √©ducateur activ√©"); } else toast("PIN incorrect"); };
$("#btnSchema").onclick=()=>{ const tk=todayKey(); state.history[tk]=state.history[tk]||{}; state.history[tk]["schema"]=(state.history[tk]["schema"]||0)+1; state.medals+=1; save(); refreshCounters(); toast("1 m√©daille ajout√©e"); };
$("#resetDay").onclick=()=>{ const tk=todayKey(); state.history[tk]={}; save(); toast("Journ√©e r√©initialis√©e"); };

/* Objectifs CRUD */
function renderObjList(){
  const box=$("#objList"); box.innerHTML="";
  state.objectives.forEach(o=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<div class="row"><div><b>${o.title}</b> ¬∑ code: <code>${o.id}</code> ¬∑ mode: <code>${o.mode}</code> ¬∑ min: <code>${o.min}s</code> ¬∑ vid√©o: <code>${o.video||'‚Äî'}</code></div>
    <div><button class="btn" data-act="edit" data-id="${o.id}">‚úèÔ∏è</button> <button class="btn red" data-act="del" data-id="${o.id}">üóëÔ∏è</button></div></div>`;
    box.appendChild(c);
  });
  $("#btnAddObj").onclick=()=>openObjDialog();
  box.querySelectorAll("button").forEach(b=>{
    const id=b.dataset.id, act=b.dataset.act;
    b.onclick=()=>{ if(act==="edit") openObjDialog(id); if(act==="del"){ const i=state.objectives.findIndex(x=>x.id===id); if(i>=0){ state.objectives.splice(i,1); save(); renderObjList(); toast("Objectif supprim√©"); } } };
  });
}
function openObjDialog(id=null){
  const o=id? state.objectives.find(x=>x.id===id) : {id:"",title:"",mode:"auto",min:30,video:""};
  $("#objTitle").textContent= id? "Modifier l‚Äôobjectif" : "Nouvel objectif";
  $("#objName").value=o.title||""; $("#objCode").value=o.id||""; $("#objMode").value=o.mode||"auto"; $("#objMin").value=o.min||0; $("#objVideo").value=o.video||"";
  $("#dlgObj").showModal();
  $("#objCancel").onclick=()=>$("#dlgObj").close();
  $("#objSave").onclick=()=>{ const n={ id:$("#objCode").value.trim()||o.id||("obj_"+Date.now()), title:$("#objName").value.trim()||"Objectif", mode:$("#objMode").value, min:parseInt($("#objMin").value||"0"), video:$("#objVideo").value.trim() };
    if(n.mode==="edu"){ n.min=0; } // pas de timer pour ‚Äú√âducateur‚Äù
    const idx=state.objectives.findIndex(x=>x.id===n.id);
    if(id && id!==n.id){ const iOld=state.objectives.findIndex(x=>x.id===id); if(iOld>=0) state.objectives.splice(iOld,1); }
    if(idx>=0) state.objectives[idx]=n; else state.objectives.push(n);
    save(); $("#dlgObj").close(); renderObjList(); toast("Objectif enregistr√©");
  };
}

/* Items CRUD (r√©els) */
function renderItemList(){
  const box=$("#itemList"); box.innerHTML="";
  if(!state.items.length){ box.innerHTML="<div class='tiny'>Aucun article. Ajoutez-en.</div>"; }
  state.items.forEach(it=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<div class="row"><div><b>${it.name}</b> ¬∑ prix: <code>${it.price}</code> ¬∑ <span class="tiny">${(it.imgData?'photo ‚úîÔ∏è':'photo ‚ùå')}</span></div>
    <div><button class="btn" data-act="edit" data-id="${it.id}">‚úèÔ∏è</button> <button class="btn red" data-act="del" data-id="${it.id}">üóëÔ∏è</button></div></div>`;
    box.appendChild(c);
  });
  $("#btnAddItem").onclick=()=>openItemDialog();
  box.querySelectorAll("button").forEach(b=>{
    const id=b.dataset.id, act=b.dataset.act;
    b.onclick=()=>{ if(act==="edit") openItemDialog(id); if(act==="del"){ const i=state.items.findIndex(x=>x.id===id); if(i>=0){ state.items.splice(i,1); save(); renderItemList(); toast("Article supprim√©"); } } };
  });
}
function openItemDialog(id=null){
  const it=id? state.items.find(x=>x.id===id) : {id:"",name:"",price:10,imgData:""};
  $("#itemTitle").textContent= id? "Modifier l‚Äôarticle" : "Nouvel article";
  $("#itemName").value=it.name||""; $("#itemPrice").value=it.price||10; $("#itemImg").value="";
  $("#dlgItem").showModal();
  $("#itemCancel").onclick=()=>$("#dlgItem").close();
  $("#itemSave").onclick=async()=>{
    const name=$("#itemName").value.trim()||"Article";
    const price=parseInt($("#itemPrice").value||"10");
    let imgData=it.imgData||"";
    const file=$("#itemImg").files?.[0];
    if(file){ imgData = await fileToDataURL(file); }
    const n={ id: it.id || ("i_"+Date.now()), name, price, imgData };
    const idx=state.items.findIndex(x=>x.id===n.id);
    if(idx>=0) state.items[idx]=n; else state.items.push(n);
    save(); $("#dlgItem").close(); renderItemList(); toast("Article enregistr√©");
  };
}
function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* Tickets */
function renderTickets(){
  const box=$("#ticketsList"); box.innerHTML="";
  const pending = state.tickets.filter(t=>!t.used);
  if(!pending.length){ box.innerHTML="<div class='tiny'>Aucun ticket en attente.</div>"; return; }
  pending.slice().reverse().forEach(t=>{
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<div class="row"><div><b>${t.reward}</b> ¬∑ code <b>${t.code}</b> ¬∑ ${new Date(t.createdAt).toLocaleString()}</div>
      <div><button class="btn green" data-act="use" data-id="${t.id}">Valider</button> <button class="btn red" data-act="cancel" data-id="${t.id}">Annuler</button></div></div>`;
    box.appendChild(card);
  });
  box.querySelectorAll("button").forEach(b=>{
    const id=b.dataset.id, act=b.dataset.act;
    b.onclick=()=>{ if(act==="use") openTicketUse(id); if(act==="cancel"){ const t=state.tickets.find(x=>x.id===id); if(!t) return; t.used=true; t.usedAt=new Date().toISOString(); save(); renderTickets(); toast("Ticket annul√© (archiv√©)"); } };
  });
}
function openTicketUse(id){
  const t=state.tickets.find(x=>x.id===id); if(!t) return;
  $("#ticketSummary").innerHTML=`<div class="card"><b>${t.reward}</b><br/>code: <b>${t.code}</b><br/><span class="tiny">${new Date(t.createdAt).toLocaleString()}</span></div>`;
  $("#pinUse").value="";
  $("#dlgTicketUse").showModal();
  $("#tCancel").onclick=()=>$("#dlgTicketUse").close();
  $("#tValidate").onclick=()=>{ if($("#pinUse").value!==state.pin){ toast("PIN incorrect"); return; } t.used=true; t.usedAt=new Date().toISOString(); save(); $("#dlgTicketUse").close(); renderTickets(); toast("Ticket valid√© ‚úÖ"); };
}

/* R√©glages shop */
function loadShopSettings(){ $("#shopOpen").value=state.shop.open; $("#shopClose").value=state.shop.close; $("#lockShop").checked=!!state.shop.locked; }
$("#btnSaveShop").onclick=()=>{ state.shop.open=$("#shopOpen").value; state.shop.close=$("#shopClose").value; state.shop.locked=$("#lockShop").checked; save(); toast("R√©glages boutique enregistr√©s"); };

/* Impression QR */
$("#btnPrintQR").onclick=()=>{
  const win=window.open("","qrprint");
  win.document.write(`<html><head><meta charset="utf-8"><title>QR objectifs ‚Äì Didier</title>
    <style>body{font-family:system-ui,Segoe UI,Arial;padding:20px}h1{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .card{border:1px solid #ccc;border-radius:12px;padding:10px;text-align:center}
    .label{font-weight:700;margin-top:6px}</style></head><body>
    <h1>QR codes des objectifs</h1><div class="grid" id="grid"></div><script>
      const data=${JSON.stringify(state.objectives.map(o=>({id:o.id,title:o.title})))}; 
      function add(id,title){
        const wrap=document.createElement('div'); wrap.className='card';
        const box=document.createElement('div'); box.id='qr_'+id; wrap.appendChild(box);
        const lab=document.createElement('div'); lab.className='label'; lab.innerHTML=title+' ‚Äî code: <code>'+id+'</code>'; wrap.appendChild(lab);
        document.getElementById('grid').appendChild(wrap);
        new QRCode(box,{text:id, width:240, height:240, correctLevel: QRCode.CorrectLevel.M});
      }
      const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
      s.onload=()=>{ data.forEach(d=>add(d.id,d.title)); setTimeout(()=>window.print(),300); };
      document.body.appendChild(s);
    <\/script></body></html>`);
  win.document.close();
};

/* ====== Utilitaires ====== */
function refreshCounters(){ $("#medals").textContent=state.medals; $("#medalsShop").textContent=state.medals; }

/* ====== Init ====== */
$("#today").textContent=new Date().toLocaleDateString('fr-BE',{weekday:'long',day:'2-digit',month:'long'});
refreshCounters(); renderShop(); renderHistory();

/* Accessibilit√© : lecture vocale sur clic nom (fallback) */
document.addEventListener("click",(e)=>{ const el=e.target.closest(".speak"); if(el) speak(el.textContent||el.getAttribute("aria-label")||""); });
</script>
</body>
</html>
